<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Licitações - Comprasnet BA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tab-content {
            border: 1px solid #dee2e6;
            border-top: 0;
            padding: 1.5rem;
            border-radius: 0 0 .375rem .375rem;
        }
        .debug-buttons .btn {
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">Monitor de Licitações - Comprasnet Bahia</span>
        </div>
    </nav>

    <div class="container" style="max-width: 900px;">

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dia-tab" data-bs-toggle="tab" data-bs-target="#dia-tab-pane" type="button" role="tab">Licitações do Dia</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notificacoes-tab" data-bs-toggle="tab" data-bs-target="#notificacoes-tab-pane" type="button" role="tab">Notificações</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="dia-tab-pane" role="tabpanel" tabindex="0">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <h4 class="mb-2 mb-md-0">Licitações Monitoradas Hoje ({{ licitacoes_hoje|length }})</h4>
                    <div class="debug-buttons">
                        <a href="{{ url_for('forcar_busca') }}" class="btn btn-sm btn-outline-info" title="Busca novas licitações no site do Comprasnet">Forçar Verificação</a>
                        <a href="{{ url_for('testar_notificacoes') }}" class="btn btn-sm btn-outline-success" title="Envia as licitações da lista abaixo para o Telegram">Testar Notificação</a>
                        <a href="{{ url_for('limpar_db') }}" class="btn btn-sm btn-outline-danger" title="Apaga as licitações da lista abaixo para novos testes">Limpar Lista</a>
                    </div>
                </div>

                <p class="text-muted">Clique no número da licitação para ver todos os detalhes e o histórico de eventos.</p>
                {% if licitacoes_hoje %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Número</th>
                                <th scope="col">Órgão</th>
                                <th scope="col">Objeto</th>
                                <th scope="col">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for licitacao in licitacoes_hoje %}
                            <tr>
                                <!-- LINK PARA A NOVA ROTA DE DETALHES -->
                                <td>
                                    <a href="{{ url_for('detalhes', numero_completo=licitacao.numero_completo) }}" class="fw-bold">
                                        {{ licitacao.numero_completo }}
                                    </a>
                                </td>
                                <td>{{ licitacao.orgao }}</td>
                                <td>{{ licitacao.objeto }}</td>
                                <td><span class="badge bg-secondary">{{ licitacao.status }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    Nenhuma licitação foi encontrada ou atualizada hoje até o momento.
                </div>
                {% endif %}
            </div>

            <div class="tab-pane fade" id="notificacoes-tab-pane" role="tabpanel" tabindex="0">
                <h4 class="mb-3">Inscreva-se para Receber Notificações</h4>
                <p>Receba alertas em tempo real sobre novas licitações e atualizações de status diretamente no seu Telegram.</p>
                <div class="card bg-light">
                    <div class="card-body">
                        <h5>Como se inscrever:</h5>
                        <ol>
                            <li class="mb-2">
                                <strong>Primeiro, inicie uma conversa com o bot no Telegram.</strong> <br>
                                <small class="text-muted">O bot não pode enviar a primeira mensagem. Procure pelo username do seu bot e clique em "Começar" ou envie um "/start".</small>
                            </li>
                            <li>No Telegram, procure pelo bot <strong>@userinfobot</strong> e inicie uma conversa.</li>
                            <li>O bot responderá com várias informações. Copie o número ao lado de "<strong>Id:</strong>". Este é o seu Chat ID.</li>
                            <li>Cole o seu Chat ID no campo abaixo e clique em "Inscrever".</li>
                        </ol>
                        <hr>
                        <form action="{{ url_for('inscrever') }}" method="post">
                            <div class="mb-3">
                                <label for="chat_id" class="form-label"><strong>Seu Telegram Chat ID</strong></label>
                                <input type="text" class="form-control" name="chat_id" id="chat_id" placeholder="Ex: 123456789" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Inscrever</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
